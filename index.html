<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>حاسبة كوب القهوة</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Outfit:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg: #faf4ec;
      --bg-2: #f3e4d3;
      --card: #ffffff;
      --card-soft: #fdf7f1;
      --text: #2f2115;
      --muted: #8a7360;
      --accent: #c4804b;
      --accent-soft: #f2c9a1;
      --accent-strong: #9a5422;
      --border: rgba(128, 94, 62, 0.16);
      --shadow-soft: 0 22px 50px rgba(131, 94, 64, 0.18);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Cairo", "Outfit", -apple-system, system-ui, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(250, 230, 204, 0.8), transparent 60%),
        radial-gradient(circle at 90% 10%, rgba(218, 170, 120, 0.45), transparent 55%),
        radial-gradient(circle at 50% 90%, rgba(203, 156, 113, 0.35), transparent 55%),
        linear-gradient(160deg, var(--bg), var(--bg-2));
      color: var(--text);
      min-height: 100vh;
      padding: 18px 16px;
      display: flex;
      justify-content: center;
      transition: background 0.4s ease;
    }
    /* ثيم القهوة الباردة: ألوان ثلج وأزرق فاتح (تعديل متغيرات الألوان كاملة) */
    body.cold-mode {
      --bg: #e0f2fe;
      --bg-2: #eff6ff;
      --card: #f9fbff;
      --card-soft: #edf5ff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-soft: #bfdbfe;
      --accent-strong: #1d4ed8;
      --border: rgba(148, 163, 184, 0.4);
      --shadow-soft: 0 22px 50px rgba(37, 99, 235, 0.25);

      background:
        radial-gradient(circle at 10% 0%, rgba(219, 242, 255, 0.9), transparent 60%),
        radial-gradient(circle at 90% 20%, rgba(147, 197, 253, 0.6), transparent 55%),
        radial-gradient(circle at 50% 95%, rgba(191, 219, 254, 0.55), transparent 55%),
        linear-gradient(165deg, #e0f2fe, #f5f3ff);
    }

    .shell {
      width: min(460px, 100%);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--muted);
      font-size: 0.86rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .app-header span:first-child {
      font-weight: 700;
      color: var(--accent-strong);
    }

    .container {
      position: relative;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.9), rgba(255,255,255,0.96));
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 18px 16px 22px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }
    body.cold-mode .container {
      background: radial-gradient(circle at top left, rgba(239,246,255,0.98), rgba(248,250,252,1));
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at -10% 0%, rgba(242, 201, 161, 0.35), transparent 55%),
        radial-gradient(circle at 120% 0%, rgba(196, 128, 75, 0.25), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
    }
    body.cold-mode .container::before {
      background:
        radial-gradient(circle at -10% 0%, rgba(191, 219, 254, 0.7), transparent 55%),
        radial-gradient(circle at 120% 0%, rgba(129, 212, 250, 0.45), transparent 55%);
    }
    .content {
      position: relative;
      z-index: 1;
    }

    .hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 14px;
    }
    .hero-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .hero-title {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    h1 {
      margin: 0;
      font-size: 1.45rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .hero-tag {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(247, 230, 209, 0.9);
      color: var(--accent-strong);
      font-size: 0.74rem;
      font-weight: 700;
    }
    body.cold-mode .hero-tag {
      background: rgba(219, 234, 254, 0.95);
      color: var(--accent-strong);
    }
    p.lead {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
      font-weight: 700;
    }
    .hero-illustration {
      width: 88px;
      height: 88px;
      border-radius: 26px;
      background:
        radial-gradient(circle at 30% 0%, #fff7ed, transparent 55%),
        radial-gradient(circle at 70% 100%, #fed7aa, transparent 55%),
        linear-gradient(145deg, #f97316, #9a3412);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow:
        0 16px 40px rgba(148, 94, 54, 0.55),
        0 0 0 1px rgba(255, 255, 255, 0.6);
    }
    body.cold-mode .hero-illustration {
      background:
        radial-gradient(circle at 30% 0%, #eff6ff, transparent 55%),
        radial-gradient(circle at 70% 100%, #bfdbfe, transparent 55%),
        linear-gradient(145deg, #0ea5e9, #2563eb);
      box-shadow:
        0 16px 40px rgba(37, 99, 235, 0.5),
        0 0 0 1px rgba(239, 246, 255, 0.9);
    }
    .cup {
      width: 54px;
      height: 40px;
      border-radius: 16px 16px 20px 20px;
      background: #fefce8;
      position: relative;
      box-shadow:
        0 8px 16px rgba(124, 45, 18, 0.35),
        inset 0 0 0 1px rgba(250, 204, 170, 1);
    }
    body.cold-mode .cup {
      background: #e0f2fe;
      box-shadow:
        0 8px 16px rgba(37, 99, 235, 0.3),
        inset 0 0 0 1px rgba(191, 219, 254, 1);
    }
    .cup::before {
      content: "";
      position: absolute;
      inset: 7px 7px 14px;
      border-radius: 12px 12px 18px 18px;
      background: linear-gradient(180deg, #7c2d12, #431407);
    }
    body.cold-mode .cup::before {
      background: linear-gradient(180deg, #0c4a6e, #075985);
    }
    .cup::after {
      content: "";
      position: absolute;
      right: -10px;
      top: 12px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid #fed7aa;
      box-shadow: inset 0 0 0 2px #f97316;
      background: transparent;
    }
    body.cold-mode .cup::after {
      border-color: #bfdbfe;
      box-shadow: inset 0 0 0 2px #2563eb;
    }
    .steam {
      position: absolute;
      top: -10px;
      left: 16px;
      display: flex;
      gap: 5px;
    }
    body.cold-mode .steam {
      display: none;
    }
    .steam span {
      display: block;
      width: 4px;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(to top, rgba(248, 250, 252, 0), rgba(255, 255, 255, 0.95));
      opacity: 0.8;
      animation: steam 2.2s ease-in-out infinite;
    }
    .steam span:nth-child(2) { animation-delay: .3s; }
    .steam span:nth-child(3) { animation-delay: .6s; }

    @keyframes steam {
      0% { transform: translateY(6px); opacity: 0; }
      35% { opacity: 0.9; }
      100% { transform: translateY(-10px); opacity: 0; }
    }
    .ice-cubes {
      position: absolute;
      top: -8px;
      left: 12px;
      display: none;
      gap: 3px;
    }
    body.cold-mode .ice-cubes {
      display: flex;
    }
    .ice-cube {
      width: 6px;
      height: 6px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 2px;
      box-shadow: 0 1px 2px rgba(37, 99, 235, 0.3);
      animation: float 2s ease-in-out infinite;
    }
    .ice-cube:nth-child(1) { animation-delay: 0s; }
    .ice-cube:nth-child(2) { animation-delay: 0.4s; }
    .ice-cube:nth-child(3) { animation-delay: 0.8s; }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
      50% { transform: translateY(-3px) rotate(5deg); opacity: 1; }
    }

    .section-title {
      margin: 0 0 6px;
      font-size: 1.1rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .mode-toggle {
      display: inline-flex;
      padding: 5px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(214, 158, 110, 0.4);
      box-shadow: 0 6px 20px rgba(148, 94, 54, 0.12);
      gap: 5px;
    }
    body.cold-mode .mode-toggle {
      background: rgba(239, 246, 255, 0.98);
      border-color: rgba(191, 219, 254, 0.6);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.18);
    }
    .mode-chip {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--muted);
      font-weight: 700;
      transition: all 0.2s ease;
      position: relative;
    }
    .mode-chip:hover {
      background: rgba(196, 128, 75, 0.1);
      color: var(--accent);
    }
    .mode-chip.active {
      background: linear-gradient(145deg, #f97316, #ea580c);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(194, 120, 69, 0.4);
      transform: translateY(-1px);
    }
    body.cold-mode .mode-chip.active {
      background: linear-gradient(145deg, #2563eb, #1d4ed8);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    .mode-chip:active {
      transform: translateY(0) scale(0.98);
    }
    .mode-chip.active:active {
      transform: translateY(0) scale(0.98);
    }
    /* زر وضع التركيز */
    .focus-mode-btn {
      border-radius: 999px;
      border: 2px solid var(--accent);
      background: linear-gradient(145deg, var(--accent), var(--accent-strong));
      color: #ffffff;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(196, 128, 75, 0.3);
    }
    .focus-mode-btn:hover {
      background: linear-gradient(145deg, var(--accent-strong), var(--accent));
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(196, 128, 75, 0.4);
    }
    .focus-mode-btn:active {
      transform: translateY(0);
    }
    body.cold-mode .focus-mode-btn {
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    body.cold-mode .focus-mode-btn:hover {
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
    }
    /* Popup وضع التركيز */
    .focus-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(6px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    .focus-overlay.active {
      display: flex;
    }
    .focus-popup {
      background: #ffffff;
      border-radius: 24px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      border: 2px solid #e5e7eb;
      position: relative;
      animation: slideUp 0.3s ease;
    }
    .focus-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 14px;
      border-bottom: 2px solid #f3f4f6;
    }
    .focus-popup-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: #111827;
      letter-spacing: -0.02em;
    }
    .focus-popup-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .focus-popup-close:hover {
      background: #ef4444;
      color: #ffffff;
      transform: rotate(90deg);
    }
    .focus-popup-description {
      font-size: 0.88rem;
      color: #6b7280;
      text-align: center;
      margin: 0 0 20px 0;
      padding: 10px;
      background: #f9fafb;
      border-radius: 12px;
      line-height: 1.6;
      border: 1px solid #e5e7eb;
    }
    /* تعديل ألوان العناصر داخل وضع التركيز */
    .focus-popup .badge {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }
    .focus-popup .total {
      color: #111827;
    }
    .focus-popup .muted {
      color: #6b7280;
    }
    .focus-popup .pour {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .focus-popup .pour:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    .focus-popup .pour strong {
      color: #111827;
    }
    .focus-popup .pour span {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }
    .focus-popup .pour span .pour-label {
      color: #6b7280;
    }
    .focus-popup .pour span .pour-number {
      color: #111827;
    }
    .focus-popup .timer-container {
      background: #f9fafb;
      border-color: #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .focus-popup .timer-display {
      background: linear-gradient(145deg, #ffffff, #f9fafb);
      border-color: #d1d5db;
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.1),
        inset 0 1px 3px rgba(255, 255, 255, 0.9);
    }
    .focus-popup .timer-display.running {
      border-color: #3b82f6;
      box-shadow: 
        0 6px 18px rgba(59, 130, 246, 0.2),
        inset 0 1px 3px rgba(255, 255, 255, 0.9),
        0 0 15px rgba(59, 130, 246, 0.15);
    }
    .focus-popup .timer-time-text {
      color: #111827;
    }
    .focus-popup .timer-display.running .timer-time-text {
      color: #2563eb;
    }
    .focus-popup .timer-btn {
      background: #3b82f6;
      border: 1px solid #2563eb;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
    }
    .focus-popup .timer-btn:hover {
      background: #2563eb;
      border-color: #1d4ed8;
      box-shadow: 0 6px 14px rgba(59, 130, 246, 0.4);
    }
    .focus-popup .timer-btn.stop {
      background: #ef4444;
      border-color: #dc2626;
      color: #ffffff;
    }
    .focus-popup .timer-btn.stop:hover {
      background: #dc2626;
      border-color: #b91c1c;
    }
    .focus-popup .timer-reset-btn {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      color: #374151;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .focus-popup .timer-reset-btn:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: #111827;
    }
    .focus-popup .timer-reset-btn.resume {
      background: #3b82f6;
      border-color: #2563eb;
      color: #ffffff;
    }
    .focus-popup .timer-reset-btn.resume:hover {
      background: #2563eb;
      border-color: #1d4ed8;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 12px 12px 14px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 10px 25px rgba(148, 94, 54, 0.12);
    }
    body.cold-mode .card {
      background: rgba(239, 246, 255, 0.96);
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.18);
      border-color: rgba(219, 234, 254, 0.95);
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.01em;
      font-size: 0.9rem;
    }
    .field { margin-bottom: 10px; }
    .input-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .input-step {
      border-radius: 999px;
      border: 1px solid rgba(148,94,54,0.22);
      background: #fdf4e7;
      color: var(--accent-strong);
      width: 30px;
      height: 30px;
      display: grid;
      place-items: center;
      font-size: 1rem;
      font-weight: 700;
      padding: 0;
      cursor: pointer;
      transition: background .15s, transform .1s, box-shadow .15s;
    }
    .input-step:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);
    }
    input, select {
      width: 100%;
      background: var(--card-soft);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 0.98rem;
      transition: border-color .2s, transform .12s, box-shadow .2s, background .2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      transform: translateY(-1px);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(250, 250, 249, 0.9), 0 10px 22px rgba(193,128,75,0.25);
    }
    .inline {
      display: grid;
      grid-template-columns: 1.05fr 1fr;
      gap: 8px;
    }

    .output-card {
      margin-top: 14px;
      background: linear-gradient(145deg, #fefcf9, #fdf5ed);
      border-radius: 18px;
      padding: 14px 12px 15px;
      border: 1px solid rgba(250, 250, 249, 0.9);
      box-shadow: 0 14px 32px rgba(148, 94, 54, 0.18);
    }
    body.cold-mode .output-card {
      background: linear-gradient(145deg, #eff6ff, #e0f2fe);
      border-color: rgba(219, 234, 254, 0.95);
      box-shadow: 0 14px 32px rgba(59, 130, 246, 0.24);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(247, 230, 209, .9);
      color: var(--accent-strong);
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.82rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    body.cold-mode .badge {
      background: rgba(219, 234, 254, 0.95);
      color: #1d4ed8;
    }
    .badge::before {
      content: "☕";
      font-size: 0.95rem;
    }
    .total {
      font-size: 1.7rem;
      font-weight: 800;
      margin: 8px 0 2px;
      transition: transform .18s ease-out;
    }
    .total.bump { transform: scale(1.05); }
    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .pours {
      margin: 12px 0 0;
      display: grid;
      gap: 8px;
    }
    .pour {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fefaf6;
      border-radius: 14px;
      padding: 9px 10px;
      border: 1px solid rgba(244, 224, 206, 0.9);
      box-shadow: 0 7px 18px rgba(148, 94, 54, 0.15);
      transition: transform .15s ease-out, box-shadow .15s ease-out, background .15s ease-out;
    }
    body.cold-mode .pour {
      background: #eff6ff;
      border-color: rgba(191, 219, 254, 0.95);
      box-shadow: 0 7px 18px rgba(59, 130, 246, 0.18);
    }
    .pour:hover {
      transform: translateY(-1px);
      background: #fffaf5;
      box-shadow: 0 12px 24px rgba(148, 94, 54, 0.22);
    }
    body.cold-mode .pour:hover {
      background: #e0f2fe;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.28);
    }
    .pour strong { font-size: 0.95rem; }
    .pour span {
      background: rgba(250, 250, 249, 0.95);
      color: var(--accent-strong);
      padding: 6px 9px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
      min-width: 70px;
      text-align: center;
    }
    .pour span .pour-label {
      color: var(--muted);
      font-weight: 500;
      font-size: 0.75rem;
      margin-left: 4px;
    }
    .pour span .pour-number {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--accent-strong);
    }
    .hint {
      margin-top: 10px;
      background: rgba(255,255,255,0.85);
      border-radius: 14px;
      padding: 9px 10px;
      border: 1px dashed rgba(214, 158, 110, 0.7);
      color: var(--muted);
      font-size: 0.86rem;
      line-height: 1.5;
    }
    /* أنماط صفحة "عالج كوبك" */
    .fix-choices {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .fix-chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.9);
      padding: 6px 10px;
      font-size: 0.82rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text);
      transition: background .15s, transform .1s, box-shadow .15s, border-color .15s;
    }
    .fix-chip span {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .fix-chip.active {
      background: var(--accent);
      color: #f9fafb;
      border-color: var(--accent-strong);
      box-shadow: 0 8px 18px var(--shadow-soft);
    }
    .fix-chip:active {
      transform: translateY(1px) scale(0.97);
    }
    .fix-step {
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      background: var(--card-soft);
      border: 1px solid var(--border);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .fix-step-title {
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--accent-strong);
      font-size: 0.9rem;
    }
    .fix-actions {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.8rem;
    }
    .fix-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: background .15s, transform .1s, box-shadow .15s;
    }
    .fix-btn-next {
      background: var(--accent);
      color: #f9fafb;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .fix-btn-reset {
      background: rgba(148,163,184,0.12);
      color: var(--muted);
    }
    .fix-btn:active {
      transform: translateY(1px) scale(0.97);
    }
    footer {
      text-align: center;
      margin-top: 0;
      color: var(--muted);
      font-size: 0.8rem;
      font-weight: 700;
      line-height: 1.4;
    }
    /* أنماط قسم الطحنة الديناميكي */
    #grindResult {
      animation: fadeInUp 0.4s ease-out;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    body.cold-mode #grindResult {
      background: linear-gradient(145deg, rgba(219,234,254,0.6), rgba(191,219,254,0.4)) !important;
      border-color: rgba(37,99,235,0.3) !important;
    }
    /* أنماط المؤقت */
    .timer-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(148, 94, 54, 0.08);
    }
    body.cold-mode .timer-container {
      background: rgba(239, 246, 255, 0.98);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.12);
    }
    .timer-title {
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 600;
      text-align: center;
      margin-bottom: 4px;
    }
    .timer-display {
      width: 120px;
      height: 120px;
      margin: 0 auto;
      position: relative;
      border-radius: 50%;
      background: linear-gradient(145deg, #ffffff, #fef7f0);
      border: 3px solid var(--accent);
      box-shadow: 
        0 4px 12px rgba(148, 94, 54, 0.15),
        inset 0 2px 4px rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .timer-time-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--accent-strong);
      font-variant-numeric: tabular-nums;
      text-align: center;
    }
    .timer-display.running .timer-time-text {
      color: var(--accent);
    }
    .timer-display.finished .timer-time-text {
      color: #dc2626;
    }
    body.cold-mode .timer-display {
      background: linear-gradient(145deg, #ffffff, #eff6ff);
      box-shadow: 
        0 4px 12px rgba(37, 99, 235, 0.18),
        inset 0 2px 4px rgba(255, 255, 255, 0.9);
    }
    .timer-display.running {
      border-color: var(--accent);
      animation: pulseTimer 2s ease-in-out infinite;
      box-shadow: 
        0 6px 18px rgba(196, 128, 75, 0.25),
        inset 0 2px 4px rgba(255, 255, 255, 0.9),
        0 0 15px rgba(196, 128, 75, 0.15);
    }
    body.cold-mode .timer-display.running {
      box-shadow: 
        0 6px 18px rgba(37, 99, 235, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.9),
        0 0 15px rgba(37, 99, 235, 0.2);
    }
    .timer-display.finished {
      border-color: #dc2626;
      animation: shake 0.5s ease-in-out;
      box-shadow: 
        0 6px 18px rgba(220, 38, 38, 0.25),
        inset 0 2px 4px rgba(255, 255, 255, 0.9);
    }
    @keyframes pulseTimer {
      0%, 100% { 
        transform: scale(1);
        opacity: 1;
      }
      50% { 
        transform: scale(1.02);
        opacity: 0.9;
      }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      25% { transform: translateX(-6px) rotate(-2deg); }
      75% { transform: translateX(6px) rotate(2deg); }
    }
    .timer-controls-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .timer-mode-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--card-soft);
      padding: 4px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    body.cold-mode .timer-mode-toggle {
      background: rgba(239, 246, 255, 0.9);
    }
    .timer-mode-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px 10px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .timer-mode-btn:hover {
      background: rgba(196, 128, 75, 0.1);
      color: var(--accent);
    }
    .timer-mode-btn.active {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(196, 128, 75, 0.2);
    }
    body.cold-mode .timer-mode-btn.active {
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
    }
    .timer-mode-btn:active {
      transform: scale(0.97);
    }
    .timer-input-group {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--card-soft);
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    body.cold-mode .timer-input-group {
      background: rgba(239, 246, 255, 0.9);
    }
    .timer-input {
      width: 45px;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 700;
      text-align: center;
      padding: 0;
    }
    .timer-input:focus {
      outline: none;
    }
    .timer-label {
      font-size: 0.8rem;
      color: var(--muted);
      font-weight: 600;
    }
    .timer-btn {
      flex: 1;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      padding: 10px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 44px;
      box-shadow: 0 4px 10px rgba(196, 128, 75, 0.25);
      user-select: none;
      -webkit-user-select: none;
      position: relative;
      z-index: 1;
    }
    .timer-reset-btn {
      background: rgba(148, 163, 184, 0.2);
      color: var(--muted);
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.15);
    }
    .timer-reset-btn:hover {
      background: rgba(148, 163, 184, 0.3);
      color: var(--text);
      box-shadow: 0 6px 14px rgba(148, 163, 184, 0.2);
    }
    .timer-reset-btn.resume {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(196, 128, 75, 0.25);
    }
    .timer-reset-btn.resume:hover {
      background: var(--accent-strong);
      box-shadow: 0 6px 14px rgba(196, 128, 75, 0.35);
    }
    .timer-btn * {
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
    }
    .timer-btn:hover {
      background: var(--accent-strong);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(196, 128, 75, 0.35);
    }
    .timer-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(196, 128, 75, 0.25);
    }
    .timer-btn.stop {
      background: #dc2626;
      box-shadow: 0 4px 10px rgba(220, 38, 38, 0.25);
    }
    .timer-btn.stop:hover {
      background: #b91c1c;
      box-shadow: 0 6px 14px rgba(220, 38, 38, 0.35);
    }
    body.cold-mode .timer-btn {
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.25);
    }
    body.cold-mode .timer-btn:hover {
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.35);
    }
  </style>
</head>
<body>
  <main class="shell">
    <header class="app-header" aria-hidden="true"></header>

    <section class="container">
      <div class="content">
        <div class="hero">
          <div class="hero-main">
            <div class="hero-title">
              <h1>حاسبة كوب القهوة</h1>
            </div>
            <p class="lead">لو ما كنت تنام بحصة الرياضيات هل كنت بتحتاج هالموقع؟</p>
          </div>
          <div class="hero-illustration" aria-hidden="true">
            <div class="cup">
              <div class="steam">
                <span></span><span></span><span></span>
              </div>
              <div class="ice-cubes">
                <span class="ice-cube"></span>
                <span class="ice-cube"></span>
                <span class="ice-cube"></span>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
          <div class="mode-toggle" id="brewModeToggle">
            <button type="button" class="mode-chip active" data-mode="hot" data-view="brew">القهوة الحارة</button>
            <button type="button" class="mode-chip" data-mode="cold" data-view="brew">القهوة الباردة</button>
          </div>
          <button type="button" class="focus-mode-btn" id="focusModeBtn">وضع التركيز</button>
        </div>

        <!-- صفحة إعداد القهوة (الحارة / الباردة) -->
        <div id="brew-view">
          <p class="section-title">المدخلات</p>
          <div class="card">
            <div class="field">
              <label for="coffee">كمية البن (جرام)</label>
              <div class="input-row">
                <button type="button" class="input-step" data-step="-1">−</button>
                <input id="coffee" type="number" min="1" step="1" value="20" inputmode="numeric" placeholder="مثال: 20">
                <button type="button" class="input-step" data-step="1">+</button>
              </div>
            </div>

            <div class="field inline">
              <div>
                <label for="ratio">الريشيو</label>
                <select id="ratio">
                  <option value="7">1 / 7</option>
                  <option value="8">1 / 8</option>
                  <option value="10">1 / 10</option>
                  <option value="12">1 / 12</option>
                  <option value="15" selected>1 / 15</option>
                  <option value="16">1 / 16</option>
                  <option value="17">1 / 17</option>
                  <option value="18">1 / 18</option>
                  <option value="custom">مخصص</option>
                </select>
                <div id="ratioInfo" class="muted" style="font-size:0.82rem;margin-top:4px;"></div>
              </div>
              <div id="custom-wrapper" style="display:none">
                <label for="customRatio">ريشيو مخصص</label>
                <input id="customRatio" type="number" min="7" max="25" step="0.1" value="15.0" inputmode="decimal" placeholder="مثال: 15.0">
              </div>
            </div>
          </div>

          <p class="section-title" style="margin-top:14px;">تفاصيل الكوب والصبات:</p>
          <div class="output-card">
            <span class="badge">الإجمالي</span>
            <div class="total" id="totalWater">-- مل</div>
            <div class="muted" id="summary"></div>
            <div class="muted" id="coldLine" style="font-size:0.85rem;margin-top:4px;display:none;"></div>

            <div class="pours" id="pours"></div>
            <div style="margin-top:14px; padding-top:12px; border-top:1px solid var(--border);">
              <p style="margin:0; font-weight:700; font-size:0.85rem; color:#d82929; line-height:1.5; text-align:center;">
                ارجع صب الماء في كل مرة بعد ما تشوف سطح القهوة
              </p>
            </div>
            <div class="timer-container" style="margin-top: 14px;">
              <div class="timer-title">مؤقت (لو تحتاجه)</div>
              <div class="timer-display" id="timerDisplay">
                <div class="timer-time-text" id="timerTimeText">00:00</div>
              </div>
              <div class="timer-controls-row">
                <button type="button" class="timer-btn" id="timerBtn">ابدأ</button>
                <button type="button" class="timer-btn timer-reset-btn" id="timerResetBtn">إيقاف مؤقت</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- قسم عالج كوبك منفصل -->
    <section class="container" style="margin-top:10px;">
      <div class="content">
        <p class="section-title">عالج كوبك</p>
        <div class="card">
          <p class="lead" style="font-size:0.92rem; margin-bottom:6px;">
            كيف طعم الكوب معك؟
          </p>
          <div class="fix-choices" id="fixChoices">
            <button type="button" class="fix-chip" data-issue="bitter"><span>مرارة عالية</span></button>
            <button type="button" class="fix-chip" data-issue="acidic"><span>حمضية عالية</span></button>
            <button type="button" class="fix-chip" data-issue="cold"><span>الكوب بارد</span></button>
            <button type="button" class="fix-chip" data-issue="thin"><span>القوام خفيف</span></button>
            <button type="button" class="fix-chip" data-issue="burnt"><span>طعم حرق</span></button>
          </div>

          <div class="fix-step" id="fixStepBox" style="display:none;">
            <div class="fix-step-title" id="fixStepTitle"></div>
            <div class="muted" id="fixStepText"></div>
            <div class="fix-actions">
              <button type="button" class="fix-btn fix-btn-reset" id="fixReset">تمام</button>
              <button type="button" class="fix-btn fix-btn-next" id="fixNext">ما زبطت، وش أسوي؟</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- قسم الطحنة ومعلومات سريعة -->
    <section class="container" style="margin-top:10px;">
      <div class="content">
        <p class="section-title">درجة الطحن</p>
        <p style="font-size:0.82rem; color:var(--muted); line-height:1.6; margin:0 0 12px 0; padding-right:4px;">
          مافي أحد بيقدر يعطيك درجة الطحن الأكيدة إلا لو عنده نفس مطحنتك وقهوتك وحتى نفس تاريخ حمصتها.. الشغلة كلها (بين البين)، هذا القسم يساعدك فقط بشكل تقريبي، ويوفر عليك هدر
        </p>
        <div class="card" id="grind-notes">
          <div class="field">
            <label for="coffeeType">اختر نوع القهوة</label>
            <select id="coffeeType">
              <option value="">-- اختر نوع القهوة --</option>
              <option value="sumatra">سومطرة</option>
              <option value="salvador">سلفادور</option>
              <option value="honduras">هندوراس</option>
              <option value="colombia">كولومبيا</option>
              <option value="mexico">المكسيك</option>
              <option value="guatemala">غواتيمالا</option>
              <option value="costa-rica">كوستاريكا</option>
              <option value="nicaragua">نيكاراغوا</option>
              <option value="panama">بنما</option>
              <option value="peru">بيرو</option>
              <option value="ethiopia">أثيوبيا</option>
              <option value="yemen">اليمن</option>
              <option value="rwanda">راوندا</option>
              <option value="uganda">أوغندا</option>
              <option value="burundi">بورندي</option>
              <option value="brazil">البرازيل</option>
              <option value="kenya">كينيا</option>
            </select>
          </div>
          <div id="grindResult" style="display:none; margin-top:12px; padding:12px; background:linear-gradient(145deg, rgba(247,230,209,0.6), rgba(242,201,161,0.4)); border-radius:14px; border:1px solid rgba(196,128,75,0.3);">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <span style="font-size:1.2rem;">☕</span>
              <strong style="color:var(--accent-strong); font-size:0.95rem;">درجة الطحنة المناسبة:</strong>
            </div>
            <div id="grindLevel" style="font-size:1.1rem; font-weight:700; color:var(--accent-strong); margin-top:4px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- قسم معلومات سريعة -->
    <section class="container" style="margin-top:10px;">
      <div class="content">
        <p class="section-title">معلومات سريعة</p>
        <div class="card" id="quick-notes">
          <p class="lead" style="font-size:0.92rem; margin-bottom:6px;">
          </p>
          <ul class="muted" style="margin:0; padding-right:18px; font-size:0.88rem; line-height:1.7;">
            <li>أفضل ماء تستخدمه للترشيح: نوفا - تانيا.</li>
            <li>أفضل فلاتر: من شركة كافيك.</li>
            <li>جرب تثبت على وصفة واحدة وتقلل تغيير العوامل، وبعدين طوّر منها.</li>
            <li>حاول تصب بثبات، وبنزول عند سطح القهوة.</li>
            <li>لا تحكم على قهوتك من أول أو ثاني كوب، ياخي اصبر.</li>


          </ul>
        </div>
      </div>
    </section>

    <!-- Popup وضع التركيز -->
    <div class="focus-overlay" id="focusOverlay">
      <div class="focus-popup">
        <div class="focus-popup-header">
          <h2 class="focus-popup-title">وضع التركيز</h2>
          <button type="button" class="focus-popup-close" id="focusCloseBtn">×</button>
        </div>
        <p class="focus-popup-description">هذا الوضع يساعدك على التركيز أثناء التحضير، بدون باقي أقسام الصفحة</p>
        <div id="focusContent">
          <!-- سيتم نسخ المحتوى هنا -->
        </div>
      </div>
    </div>

    <footer style="text-align:center; font-size:1.2rem; margin-bottom:0;">♥️</footer>
    <footer style="margin-top:0;">الكوب اللي يروقك</footer>
    <footer style="margin-top:0;">هدية من أحمد سليمان لك</footer>
    <footer style="margin-top:8px;">
      <div style="margin-bottom:8px; font-size:0.9rem; font-weight:600; color:var(--text);">تواصل معي:</div>
      <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
        <a href="https://t.me/iAhmadH" target="_blank" rel="noopener noreferrer" style="display:inline-flex; align-items:center; gap:6px; color:var(--accent); text-decoration:none; font-size:0.9rem; font-weight:600; transition:transform 0.2s, opacity 0.2s; padding:6px 12px; border-radius:8px; background:rgba(255,255,255,0.5);" onmouseover="this.style.opacity='0.8'; this.style.transform='translateY(-1px)'" onmouseout="this.style.opacity='1'; this.style.transform='translateY(0)'">
          <span>تليقرام</span>
        </a>
        <a href="https://www.snapchat.com/@iahmad_soliman" target="_blank" rel="noopener noreferrer" style="display:inline-flex; align-items:center; gap:6px; color:var(--accent); text-decoration:none; font-size:0.9rem; font-weight:600; transition:transform 0.2s, opacity 0.2s; padding:6px 12px; border-radius:8px; background:rgba(255,255,255,0.5);" onmouseover="this.style.opacity='0.8'; this.style.transform='translateY(-1px)'" onmouseout="this.style.opacity='1'; this.style.transform='translateY(0)'">
          <span>سناب</span>
        </a>
      </div>
    </footer>
  </main>

  <script>
    const coffeeInput = document.getElementById('coffee');
    const ratioSelect = document.getElementById('ratio');
    const customWrapper = document.getElementById('custom-wrapper');
    const customRatioInput = document.getElementById('customRatio');
    const totalWaterEl = document.getElementById('totalWater');
    const summaryEl = document.getElementById('summary');
    const poursEl = document.getElementById('pours');
    const ratioInfoEl = document.getElementById('ratioInfo');
    const coldLineEl = document.getElementById('coldLine');
    const stepButtons = Array.from(document.querySelectorAll('.input-step'));
    const modeChips = Array.from(document.querySelectorAll('.mode-chip'));
    const fixChoices = document.getElementById('fixChoices');
    const fixStepBox = document.getElementById('fixStepBox');
    const fixStepTitle = document.getElementById('fixStepTitle');
    const fixStepText = document.getElementById('fixStepText');
    const fixNextBtn = document.getElementById('fixNext');
    const fixResetBtn = document.getElementById('fixReset');
    let currentMode = 'hot'; // حار أو بارد
    let currentIssue = null;
    let currentIssueIndex = 0;

    const troubleshooting = {
      bitter: {
        title: 'مرارة عالية',
        steps: [
          'قلّل درجة حرارة الماء شوي (مثال: من 92° إلى 89-90°).',
          'لسا مُرة؟ خشن الطحنة شوي وجرّب نفس الوصفة.',
          'لسّا مزعجة؟ تأكد أن القهوة مناسبة للترشيح؛ المحاصيل الغامقة أو البلند غير المخصص للفلتر غالباً تعطي مرارة أعلى.'
        ]
      },
      acidic: {
        title: 'حمضية عالية',
        steps: [
          'زِد درجة حرارة الماء (مثال: من 89° إلى 90–92°).',
          'لسه حمضيتها عالية؟ نعّم الطحنة شوي وجرب نفس الوصفة.',
          'إذا ما زبطت معك؛ ممكن هذا المحصول ما يناسب ذائقتك وهذا طبيعي خصوصاً مع المعالجات المغسولة مثلًا، جرب الأثيوبيات بالمعالجة المجففة.'
        ]
      },
      cold: {
        title: 'الكوب بارد',
        steps: [
          'سخّن القمع والسيرفر والكوب قبل ما تبدأ الترشيح.',
          'تأكد أن كل أدواتك دافئة قبل ما تصب القهوة؛ البرودة تسحب حرارة الكوب وتخفف النكهات.'
        ]
      },
      thin: {
        title: 'القوام خفيف',
        steps: [
          'تأكد من تاريخ القهوة، القهوة القديمة تفقد النكهة والقوام.',
          'تأكد أن الطحنة طازجة وما جلست مطحونة فترة طويلة.',
          'تأكد من إحكام إغلاق الكيس بين كل استخدام.',
          'باقي خفيفة؟ قلّل الريشيو شوي، جرّب مثلاً 1/14.'
        ]
      },
      burnt: {
        title: 'طعم حرق',
        steps: [
          'لا تتحمس وترشّح بدرجة الغليان مباشرة (تصير لو ما عندك غلاية مخصصة للترشيح، اصبر شويات بعد ما تغلي الموية)',
          'تأكد أن القهوة مخصصة للترشيح، مو موجهة للأسبريسو أو حمصتها غامقة بزيادة.'
        ]
      }
    };

    function format(number) {
      return Number.isFinite(number) ? number.toFixed(0) : '--';
    }

    function calculate() {
      const coffee = parseFloat(coffeeInput.value);
      let ratio;

      if (ratioSelect.value === 'custom') {
        ratio = customRatioInput ? parseFloat(customRatioInput.value) : NaN;
      } else {
        ratio = parseFloat(ratioSelect.value);
      }

      // في الوضع البارد نضمن ألا يقل الريشيو عن 7
      if (currentMode === 'cold' && ratio < 7) {
        ratio = 7;
        if (ratioSelect.value === 'custom') {
          customRatioInput.value = ratio;
        } else {
          ratioSelect.value = '7';
        }
      }

      if (!coffee || coffee <= 0 || !ratio || ratio <= 0) {
        totalWaterEl.textContent = '-- مل';
        summaryEl.textContent = '';
        poursEl.innerHTML = '';
        ratioInfoEl.textContent = '';
        coldLineEl.style.display = 'none';
        coldLineEl.textContent = '';
        return;
      }

      const modeLabel = currentMode === 'cold' ? 'باردة' : 'حارة';
      const baseTotal = coffee * ratio; // نفس الحارة دائماً
      const totalWater = baseTotal;

      totalWaterEl.textContent = `${format(totalWater)} مل`;
      summaryEl.textContent = ""; // إخفاء سطر "قهوة 20 جرام • ريشيو ..."
      if (currentMode === 'cold') {
        ratioInfoEl.innerHTML =
          `<strong style="font-size:0.86rem;">(نصف الكمية قهوة، ونصفها ثلج)</strong>`;
      } else {
        ratioInfoEl.innerHTML =
          `كل ١ جرام بن ≈ ${ratio.toFixed(1)} مل ماء` +
          `<br><strong style="font-size:0.86rem;">(خلك أفضل على 1/15)</strong>`;
      }

      if (currentMode === 'hot') {
        const bloom = coffee * 2 + 10; // ترطيب = ضعف البن + ١٠ مل
        const remaining = totalWater - bloom;
        const eachPour = remaining / 4;

        // كميات وتراكم بعد كل صبة
        const totals = [
          bloom,
          bloom + eachPour,
          bloom + eachPour * 2,
          bloom + eachPour * 3,
          totalWater,
        ];

        const pours = [
          { label: 'الترطيب', amount: bloom, total: totals[0] },
          { label: 'الصبة ٢', amount: eachPour, total: totals[1] },
          { label: 'الصبة ٣', amount: eachPour, total: totals[2] },
          { label: 'الصبة ٤', amount: eachPour, total: totals[3] },
          { label: 'الصبة ٥', amount: eachPour, total: totals[4] },
        ];

        poursEl.innerHTML = pours
          .map(
            (p) => `
              <div class="pour">
                <div>
                  <strong>${p.label}</strong>
                  <div class="muted" style="font-size:0.82rem;margin-top:2px;">
                    مقدار الصبة: ${format(p.amount)} مل
                  </div>
                </div>
                <span><span class="pour-label">صب إلى:</span> <span class="pour-number">${format(p.total)} مل</span></span>
              </div>`
          )
          .join('');

        coldLineEl.style.display = 'none';
        coldLineEl.textContent = '';
      } else {
        // القهوة الباردة: نفس الإجمالي، لكن نصفه ماء يمر على البن ونصفه ثلج في السيرفر
        const coldTotal = baseTotal;
        const coldWater = coldTotal / 2;
        const coldIce = coldTotal - coldWater; // لضبط التقريب

        const bloomCold = Math.min(coldWater, coffee * 2 + 10);
        const remainingCold = coldWater - bloomCold;
        const eachPourCold = remainingCold / 4;

        const totalsCold = [
          bloomCold,
          bloomCold + eachPourCold,
          bloomCold + eachPourCold * 2,
          bloomCold + eachPourCold * 3,
          coldWater,
        ];

        const coldPours = [
          { label: 'الترطيب', amount: bloomCold, total: totalsCold[0] },
          { label: 'الصبة ٢', amount: eachPourCold, total: totalsCold[1] },
          { label: 'الصبة ٣', amount: eachPourCold, total: totalsCold[2] },
          { label: 'الصبة ٤', amount: eachPourCold, total: totalsCold[3] },
          { label: 'الصبة ٥', amount: eachPourCold, total: totalsCold[4] },
        ];

        poursEl.innerHTML = coldPours
          .map(
            (p) => `
              <div class="pour">
                <div>
                  <strong>${p.label}</strong>
                  <div class="muted" style="font-size:0.82rem;margin-top:2px;">
                    مقدار الصبة (ماء): ${format(p.amount)} مل
                  </div>
                </div>
                <span><span class="pour-label">صب إلى:</span> <span class="pour-number">${format(p.total)} مل</span></span>
              </div>`
          )
          .join('');

        coldLineEl.style.display = 'block';
        coldLineEl.innerHTML = `<strong:</strong> إجمالي ${format(coldTotal)} مل : ترشيح ${format(coldWater)} مل + <strong>ثلج ${format(coldIce)} مل </strong>في السيرفر.`;
      }

      // حركة خفيفة على الإجمالي عند التحديث
      totalWaterEl.classList.remove('bump');
      void totalWaterEl.offsetWidth; // reflow لإعادة تشغيل الأنيميشن
      totalWaterEl.classList.add('bump');
    }

    stepButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const step = parseInt(btn.dataset.step, 10) || 1;
        let current = parseFloat(coffeeInput.value) || 0;
        current = Math.max(1, current + step);
        coffeeInput.value = current;
        calculate();
      });
    });

    modeChips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const mode = chip.dataset.mode;
        if (!mode) return;
        if (mode === currentMode) return;

        modeChips.forEach((c) => c.classList.toggle('active', c === chip));
        currentMode = mode;
        document.body.classList.toggle('cold-mode', currentMode === 'cold');
        calculate();
      });
    });

    ratioSelect.addEventListener('change', () => {
      const isCustom = ratioSelect.value === 'custom';
      if (customWrapper) {
        customWrapper.style.display = isCustom ? 'block' : 'none';
      }
      // لو اختار مخصص لأول مرة نخلي فيه قيمة افتراضية لو كان فاضي
      if (isCustom && customRatioInput && !customRatioInput.value) {
        customRatioInput.value = ratioSelect.options[ratioSelect.selectedIndex]?.value || '15';
      }
      calculate();
    });

    [coffeeInput, customRatioInput].forEach((el) => {
      if (!el) return;
      el.addEventListener('input', calculate);
    });

    // تفاعل "عالج كوبك"
    if (fixChoices) {
      Array.from(fixChoices.querySelectorAll('.fix-chip')).forEach((chip) => {
        chip.addEventListener('click', () => {
          const issueKey = chip.dataset.issue;
          if (!issueKey || !troubleshooting[issueKey]) return;

          currentIssue = issueKey;
          currentIssueIndex = 0;

          Array.from(fixChoices.querySelectorAll('.fix-chip')).forEach((c) =>
            c.classList.toggle('active', c === chip)
          );

          const issue = troubleshooting[issueKey];
          fixStepTitle.textContent = issue.title;
          fixStepText.textContent = issue.steps[0];
          fixStepBox.style.display = 'block';

          // لو خطوة وحدة فقط نخفي زر "ما زبطت؟"
          fixNextBtn.style.display = issue.steps.length > 1 ? 'inline-block' : 'none';
        });
      });
    }

    if (fixNextBtn) {
      fixNextBtn.addEventListener('click', () => {
        if (!currentIssue || !troubleshooting[currentIssue]) return;
        const issue = troubleshooting[currentIssue];
        if (currentIssueIndex < issue.steps.length - 1) {
          currentIssueIndex += 1;
          fixStepText.textContent = issue.steps[currentIssueIndex];
        }
        if (currentIssueIndex >= issue.steps.length - 1) {
          fixNextBtn.style.display = 'none';
        }
      });
    }

    if (fixResetBtn) {
      fixResetBtn.addEventListener('click', () => {
        currentIssue = null;
        currentIssueIndex = 0;
        fixStepBox.style.display = 'none';
        if (fixChoices) {
          Array.from(fixChoices.querySelectorAll('.fix-chip')).forEach((c) =>
            c.classList.remove('active')
          );
        }
      });
    }

    // إدارة قسم الطحنة
    const coffeeTypeSelect = document.getElementById('coffeeType');
    const grindResult = document.getElementById('grindResult');
    const grindLevel = document.getElementById('grindLevel');

    const grindLevels = {
      fine: { // ناعمة
        types: ['sumatra', 'salvador', 'honduras'],
        text: 'ناعمة',
        emoji: ''
      },
      medium: { // متوسطة
        types: ['colombia', 'mexico', 'guatemala', 'costa-rica', 'nicaragua', 'panama', 'peru'],
        text: 'متوسطة',
        emoji: ''
      },
      coarse: { // خشنة قليلاً
        types: ['ethiopia', 'yemen', 'rwanda', 'uganda', 'burundi', 'brazil'],
        text: 'خشنة قليلاً',
        emoji: ''
      },
      extraCoarse: { // خشنة بزيادة
        types: ['kenya'],
        text: 'خشنة بزيادة',
        emoji: ''
      }
    };

    if (coffeeTypeSelect) {
      coffeeTypeSelect.addEventListener('change', () => {
        const selectedType = coffeeTypeSelect.value;
        
        if (!selectedType) {
          grindResult.style.display = 'none';
          return;
        }

        // البحث عن نوع الطحنة المناسب
        let foundLevel = null;
        for (const [levelKey, levelData] of Object.entries(grindLevels)) {
          if (levelData.types.includes(selectedType)) {
            foundLevel = levelData;
            break;
          }
        }

        if (foundLevel) {
          grindLevel.textContent = `${foundLevel.emoji} ${foundLevel.text}`;
          grindResult.style.display = 'block';
          
          // إضافة حركة خفيفة
          grindResult.style.opacity = '0';
          grindResult.style.transform = 'translateY(-4px)';
          setTimeout(() => {
            grindResult.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            grindResult.style.opacity = '1';
            grindResult.style.transform = 'translateY(0)';
          }, 10);
        } else {
          grindResult.style.display = 'none';
        }
      });
    }

    // تحديث الألوان في الوضع البارد
    const updateGrindResultColors = () => {
      if (currentMode === 'cold') {
        grindResult.style.background = 'linear-gradient(145deg, rgba(219,234,254,0.6), rgba(191,219,254,0.4))';
        grindResult.style.borderColor = 'rgba(37,99,235,0.3)';
      } else {
        grindResult.style.background = 'linear-gradient(145deg, rgba(247,230,209,0.6), rgba(242,201,161,0.4))';
        grindResult.style.borderColor = 'rgba(196,128,75,0.3)';
      }
    };

    // تحديث الألوان عند تغيير الوضع
    modeChips.forEach((chip) => {
      chip.addEventListener('click', () => {
        setTimeout(updateGrindResultColors, 100);
      });
    });

    // إدارة المؤقت
    const timerDisplay = document.getElementById('timerDisplay');
    const timerTimeText = document.getElementById('timerTimeText');
    const timerBtn = document.getElementById('timerBtn');
    let timerInterval = null;
    let timerSeconds = 0;
    let timerMaxSeconds = 0; // الحد الأقصى للوقت

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
      if (!timerTimeText) return;
      
      // المؤقت تصاعدي فقط: يعرض الوقت المنقضي
      timerTimeText.textContent = formatTime(timerSeconds);
      
      if (timerInterval) {
        timerDisplay.classList.add('running');
        timerDisplay.classList.remove('finished');
      } else {
        timerDisplay.classList.remove('running');
        timerDisplay.classList.remove('finished');
      }
    }

    let timerPaused = false; // حالة المؤقت: false = شغال، true = متوقف

    function startTimer() {
      // الوضع التصاعدي يبدأ من 00:00 بدون حد أقصى
      timerMaxSeconds = 0; // بدون حد أقصى
      
      updateTimerDisplay();

      timerBtn.textContent = 'إيقاف';
      timerBtn.classList.add('stop');
      timerPaused = false;

      if (timerResetBtn) {
        timerResetBtn.textContent = 'إيقاف مؤقت';
        timerResetBtn.classList.remove('resume');
      }

      timerInterval = setInterval(() => {
        // الوضع التصاعدي: يبدأ من 0 ويرتفع بدون حد
        timerSeconds++;
        updateTimerDisplay();
      }, 1000);
    }

    function pauseTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerPaused = true;
      if (timerResetBtn) {
        timerResetBtn.textContent = 'استمرار';
        timerResetBtn.classList.add('resume');
      }
    }

    function resumeTimer() {
      timerPaused = false;
      timerBtn.textContent = 'إيقاف';
      timerBtn.classList.add('stop');
      if (timerResetBtn) {
        timerResetBtn.textContent = 'إيقاف مؤقت';
        timerResetBtn.classList.remove('resume');
      }

      timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
      }, 1000);
    }

    function resetTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerSeconds = 0;
      timerPaused = false;
      updateTimerDisplay();
      timerBtn.textContent = 'ابدأ';
      timerBtn.classList.remove('stop');
      if (timerResetBtn) {
        timerResetBtn.textContent = 'إيقاف مؤقت';
        timerResetBtn.classList.remove('resume');
      }
    }

    if (timerBtn) {
      timerBtn.addEventListener('click', () => {
        if (timerInterval) {
          // المؤقت شغال: إيقافه وتحويل الزر إلى "إعادة تعيين"
          pauseTimer();
          timerBtn.textContent = 'إعادة تعيين';
          timerBtn.classList.remove('stop');
        } else if (timerPaused) {
          // المؤقت متوقف: إعادة تعيين (تصفير)
          resetTimer();
        } else {
          // المؤقت صفر: بدء المؤقت
          startTimer();
        }
      });
    }

    // تهيئة العرض الأولي
    if (timerDisplay) {
      timerSeconds = 0;
      timerMaxSeconds = 0;
      updateTimerDisplay();
    }

    // زر إيقاف مؤقت
    const timerResetBtn = document.getElementById('timerResetBtn');
    if (timerResetBtn) {
      timerResetBtn.addEventListener('click', () => {
        if (timerInterval) {
          // المؤقت شغال: إيقافه وتحويل الزر إلى "استمرار"
          pauseTimer();
        } else if (timerPaused) {
          // المؤقت متوقف: استمرار من حيث توقف
          resumeTimer();
        }
      });
    }

    // إدارة وضع التركيز
    const focusModeBtn = document.getElementById('focusModeBtn');
    const focusOverlay = document.getElementById('focusOverlay');
    const focusCloseBtn = document.getElementById('focusCloseBtn');
    const focusContent = document.getElementById('focusContent');

    function openFocusMode() {
      if (!focusContent) return;
      
      // نسخ الصبات والمؤقت
      const outputCard = document.querySelector('.output-card');
      const timerContainer = document.querySelector('.timer-container');
      
      if (!outputCard || !timerContainer) return;
      
      focusContent.innerHTML = '';
      
      // نسخ الصبات
      const poursClone = document.getElementById('pours').cloneNode(true);
      const instructionDiv = document.querySelector('.output-card > div[style*="border-top"]');
      const instructionClone = instructionDiv ? instructionDiv.cloneNode(true) : null;
      
      // نسخ المؤقت
      const timerClone = timerContainer.cloneNode(true);
      
      // إنشاء محتوى الـ popup
      const focusOutputCard = outputCard.cloneNode(false);
      focusOutputCard.innerHTML = '';
      
      // إضافة الإجمالي
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = 'الإجمالي';
      focusOutputCard.appendChild(badge);
      
      const total = document.createElement('div');
      total.className = 'total';
      total.id = 'focusTotalWater';
      total.textContent = document.getElementById('totalWater').textContent;
      focusOutputCard.appendChild(total);
      
      // إضافة الصبات
      focusOutputCard.appendChild(poursClone);
      
      // إضافة التعليمات
      if (instructionClone) {
        focusOutputCard.appendChild(instructionClone);
      }
      
      // إضافة المؤقت
      focusOutputCard.appendChild(timerClone);
      
      focusContent.appendChild(focusOutputCard);
      
      // ربط المؤقت في الـ popup
      const focusTimerBtn = timerClone.querySelector('#timerBtn');
      const focusTimerResetBtn = timerClone.querySelector('#timerResetBtn');
      const focusTimerTimeText = timerClone.querySelector('#timerTimeText');
      const focusTimerDisplay = timerClone.querySelector('.timer-display');
      
      if (focusTimerBtn && focusTimerTimeText) {
        // تحديث المؤقت في الـ popup
        const updateFocusTimer = () => {
          const originalTimeText = document.querySelector('#timerTimeText');
          const originalBtn = document.getElementById('timerBtn');
          const originalResetBtn = document.getElementById('timerResetBtn');
          const originalDisplay = document.querySelector('.timer-display');
          
          if (originalTimeText) {
            focusTimerTimeText.textContent = originalTimeText.textContent;
            
            // تحديث حالة الزر الرئيسي
            focusTimerBtn.textContent = originalBtn.textContent;
            if (originalBtn.classList.contains('stop')) {
              focusTimerBtn.classList.add('stop');
            } else {
              focusTimerBtn.classList.remove('stop');
            }
            
            // تحديث حالة زر إيقاف مؤقت
            if (focusTimerResetBtn && originalResetBtn) {
              focusTimerResetBtn.textContent = originalResetBtn.textContent;
              if (originalResetBtn.classList.contains('resume')) {
                focusTimerResetBtn.classList.add('resume');
              } else {
                focusTimerResetBtn.classList.remove('resume');
              }
            }
            
            // تحديث حالة الـ display
            if (originalDisplay) {
              focusTimerDisplay.classList.remove('running', 'finished');
              if (originalDisplay.classList.contains('running')) {
                focusTimerDisplay.classList.add('running');
              }
              if (originalDisplay.classList.contains('finished')) {
                focusTimerDisplay.classList.add('finished');
              }
            }
          }
        };
        
        updateFocusTimer();
        
        // تحديث مستمر للمؤقت
        const focusTimerUpdateInterval = setInterval(() => {
          if (focusOverlay.classList.contains('active')) {
            updateFocusTimer();
          } else {
            clearInterval(focusTimerUpdateInterval);
          }
        }, 100);
        
        // ربط الأحداث - استخدام mousedown بدلاً من click لضمان الاستجابة
        focusTimerBtn.addEventListener('mousedown', (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
        
        focusTimerBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // استدعاء الدالة مباشرة
          if (timerInterval) {
            pauseTimer();
            timerBtn.textContent = 'إعادة تعيين';
            timerBtn.classList.remove('stop');
          } else if (timerPaused) {
            resetTimer();
          } else {
            startTimer();
          }
          
          // تحديث فوري ومستمر
          updateFocusTimer();
          setTimeout(updateFocusTimer, 100);
          setTimeout(updateFocusTimer, 300);
        });
        
        // أيضاً إضافة touchstart للشاشات اللمسية
        focusTimerBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // استدعاء الدالة مباشرة
          if (timerInterval) {
            pauseTimer();
            timerBtn.textContent = 'إعادة تعيين';
            timerBtn.classList.remove('stop');
          } else if (timerPaused) {
            resetTimer();
          } else {
            startTimer();
          }
          
          // تحديث فوري ومستمر
          updateFocusTimer();
          setTimeout(updateFocusTimer, 100);
          setTimeout(updateFocusTimer, 300);
        });
        
        // زر إيقاف مؤقت في وضع التركيز
        if (focusTimerResetBtn) {
          focusTimerResetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (timerInterval) {
              pauseTimer();
              if (timerResetBtn) {
                timerResetBtn.textContent = 'استمرار';
                timerResetBtn.classList.add('resume');
              }
            } else if (timerPaused) {
              resumeTimer();
            }
            
            setTimeout(updateFocusTimer, 100);
          });
        }
      }
      
      focusOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeFocusMode() {
      if (focusOverlay) {
        focusOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    if (focusModeBtn) {
      focusModeBtn.addEventListener('click', openFocusMode);
    }

    if (focusCloseBtn) {
      focusCloseBtn.addEventListener('click', closeFocusMode);
    }

    if (focusOverlay) {
      focusOverlay.addEventListener('click', (e) => {
        if (e.target === focusOverlay) {
          closeFocusMode();
        }
      });
    }

    // تحديث المحتوى في الـ popup عند تغيير الصبات
    const originalCalculate = calculate;
    calculate = function() {
      originalCalculate();
      if (focusOverlay && focusOverlay.classList.contains('active')) {
        const focusTotal = document.getElementById('focusTotalWater');
        if (focusTotal) {
          focusTotal.textContent = document.getElementById('totalWater').textContent;
        }
        const focusPours = focusContent.querySelector('#pours');
        if (focusPours) {
          focusPours.innerHTML = document.getElementById('pours').innerHTML;
        }
      }
    };

    calculate();
  </script>
</body>
</html>

